name: AI PR Review
on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: pr-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  copilot-review:
    if: false
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR head (safe read-only)
        # Checkout the PR head (from fork or same repo). We only read files/diff.
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Ensure action files are available
        run: |
          # Verify action file exists, if not fetch from base branch
          if [ ! -f .github/actions/copilot_runner/action.yml ]; then
            echo "Action files not found in PR branch, fetching from base branch..."
            BASE_REF="${{ github.event.pull_request.base.ref }}"
            git fetch origin "${BASE_REF}"
            git checkout "origin/${BASE_REF}" -- .github/actions/
          fi
          ls -la .github/actions/copilot_runner/action.yml || exit 1

      - name: Get diff between feature-branch and main
        id: get_diff
        run: |
          # Fetch the latest base branch to compare against current state
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          git fetch origin "${BASE_REF}"
          # Use the merge-base to find common ancestor and only show PR changes
          MERGE_BASE=$(git merge-base "HEAD" "origin/${BASE_REF}")
          git diff "${MERGE_BASE}..HEAD" > pr.diff
          echo "diff_file=pr.diff" >> "$GITHUB_OUTPUT"

      - name: Generate Copilot PR Review
        id: copilot-review
        uses: ./.github/actions/copilot_runner
        with:
          copilot-token: ${{ secrets.COPILOT_CLI }}
          model: claude-sonnet-4
          agent: CodeReviewer
          timeout: 300
          output-file: copilot_pr_review.txt
          include-output: true
          extract-marker: "## ðŸ¤– AI Test Review"
          prompt: |
            Review this PR against rules and system guidelines.
            PR #${{ github.event.pull_request.number }}: "${{ github.event.pull_request.title }}"
            Author: ${{ github.event.pull_request.user.login }}
            Changes: ${{ github.event.pull_request.base.ref }} â†’ ${{ github.event.pull_request.head.ref }}
            The PR diff is in: pr.diff

            Provide a structured review comment with violations, recommendations, and checklist status.

      - name: Post Copilot review comment
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            // Get the actual filename from copilot-runner output
            const outputFile = '${{ steps.copilot-review.outputs.file }}';
            console.log('Looking for output file:', outputFile);
            
            // Check if copilot review file exists
            let reviewContent = '';
            try {
              reviewContent = fs.readFileSync(outputFile, 'utf8').trim();
            } catch (error) {
              console.log('Could not read output file:', error.message);
            }
            
            // Only post comment if we have review content
            if (!reviewContent) {
              console.log('No review content generated, skipping comment.');
              return;
            }
            
            // Remove the marker line if it's still present (shared action includes it)
            const markerLine = '## ðŸ¤– AI Test Review';
            if (reviewContent.startsWith(markerLine)) {
              // Strip the marker line and any following empty lines
              reviewContent = reviewContent.substring(markerLine.length).replace(/^\s+/, '');
            }
            
            // Add stable header to review content
            const review = `## ðŸ”µ GitHub Copilot Review\n\n${reviewContent}`;
            
            // Find existing AI review comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.data.find(comment =>
              comment.body.includes('## ðŸ”µ GitHub Copilot Review')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: review
              });
              console.log('Updated existing Copilot review comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: review
              });
              console.log('Created new Copilot review comment');
            }

  gemini-review:
    if: false
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR head (safe read-only)
        # Checkout the PR head (from fork or same repo). We only read files/diff.
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Ensure action files are available
        run: |
          # Verify action file exists, if not fetch from base branch
          if [ ! -f .github/actions/gemini_runner/action.yml ]; then
            echo "Action files not found in PR branch, fetching from base branch..."
            BASE_REF="${{ github.event.pull_request.base.ref }}"
            git fetch origin "${BASE_REF}"
            git checkout "origin/${BASE_REF}" -- .github/actions/
          fi
          ls -la .github/actions/gemini_runner/action.yml || exit 1

      - name: Get diff between feature-branch and main
        id: get_diff
        run: |
          # Fetch the latest base branch to compare against current state
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          git fetch origin "${BASE_REF}"
          # Use the merge-base to find common ancestor and only show PR changes
          MERGE_BASE=$(git merge-base "HEAD" "origin/${BASE_REF}")
          git diff "${MERGE_BASE}..HEAD" > pr.diff
          echo "diff_file=pr.diff" >> "$GITHUB_OUTPUT"

      - name: Generate Gemini PR Review
        id: gemini-review
        uses: ./.github/actions/gemini_runner
        with:
          gemini-api-key: ${{ secrets.GEMINI_API_KEY }}
          model: gemini-2.5-flash
          prompt-file: .github/prompts/CodeReviewer.md
          timeout: 300
          output-file: gemini_pr_review.txt
          include-output: true
          prompt: |
            Review this PR against rules and system guidelines.
            PR #${{ github.event.pull_request.number }}: "${{ github.event.pull_request.title }}"
            Author: ${{ github.event.pull_request.user.login }}
            Changes: ${{ github.event.pull_request.base.ref }} â†’ ${{ github.event.pull_request.head.ref }}
            The PR diff is in: pr.diff

            Provide a structured review comment with violations, recommendations, and checklist status.

      - name: Post Gemini review comment
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            // Get the actual filename from gemini-runner output
            const outputFile = '${{ steps.gemini-review.outputs.file }}';
            console.log('Looking for output file:', outputFile);
            
            // Check if gemini review file exists
            let reviewContent = '';
            try {
              reviewContent = fs.readFileSync(outputFile, 'utf8').trim();
            } catch (error) {
              console.log('Could not read output file:', error.message);
            }
            
            // Only post comment if we have review content
            if (!reviewContent) {
              console.log('No review content generated, skipping comment.');
              return;
            }
            
            // Remove the marker line if it's still present (shared action includes it)
            const markerLine = '## ðŸ¤– AI Test Review';
            if (reviewContent.startsWith(markerLine)) {
              // Strip the marker line and any following empty lines
              reviewContent = reviewContent.substring(markerLine.length).replace(/^\s+/, '');
            }
            
            // Add stable header to review content
            const review = `## ðŸŸ¢ Gemini Review\n\n${reviewContent}`;
            
            // Find existing AI review comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.data.find(comment =>
              comment.body.includes('## ðŸŸ¢ Gemini Review')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: review
              });
              console.log('Updated existing Gemini review comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: review
              });
              console.log('Created new Gemini review comment');
            }
